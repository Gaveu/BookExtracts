# 02-3 指纹分析

## 操作系统指纹识别（OS Fingerprining）

获得了网络中的活跃主机之后，你最关注的事情可能就是这些主机安装了什么操作系统。要知道，网络中不仅会存在安装了各种通用操作系统的主机，还会有打印机、路由器、无线AP。准确区别出这些设备使用的操作系统对于后续渗透流程的确定和攻击模块的选择非常重要。

无论是对服务器还是个人主机的渗透测试，其操作系统都是不可绕过的一个重要环节。可以通过识别操作系统来确定自己的下一步动作，只有确定了某台主机上运行的操作系统，攻击者才可以对目标机器发动相应的攻击。比如，如果要使用缓冲区溢出攻击，攻击者需要知道目标的具体操作系统与架构。

作为主动的操作系统探测来说，操作系统特征可以通过利用一些工具在每一个操作系统的IP堆栈有自己不同特性的原理上来操作。每个操作系统响应通过的多种信息包，所以这些工具只要建立一个基于不同的操作系统对应不同的信息包的数据库，然后，要判断远程主机的操作系统，发送多种不寻常的信息包，检测其是如何响应这些信息包的，再与数据库进行对比、做出判断。

被动的操作系统探测遵循与主动的操作系统探测相同的概念，但实现的方法不同。被动特征探测基于嗅探远程主机上的通信来代替主动的去查询远程主机，所做的只是抓取从远程主机上发送的信息包。在嗅探这些信息包的基础上，可以判断远程主机的操作系统，就像主动特征探测一样。

### banner手工指纹识别

banner识别是最基础、最简单的指纹识别技术，而且在不需要其他专门的工具的情况下就可以做。操作简单，通常获取的信息也相对准确。

严格的讲，banner抓取是应用程序指纹识别而不是操作系统指纹识别。banner信息并不是操作系统本身的行为，是由应用程序自动返回的，比如apache、exchange。而且很多时候并不会直接返回操作系统信息，幸运的话，可能会看到服务程序本身的版本信息，并以此进行推断。

以ftp应用示例：

> telnet 192.168.1.1 21
>
> 或 ftp 192.168.1.1
>
> 若192.168.1.1开启了FTP的21口，则会返回ftp应用的版本信息

## Web指纹探测

Web指纹探测与操作系统指纹探测类似，只不过为了发现web服务器类型及版本。Web服务器一般有IIS、Apache等类型。发现了Web服务器的类型及其版本之后，就可以有针对性地对Web服务器进行进一步的渗透了，例如探测到Web服务器为IIS，则可以尝试利用IIS目录科协漏洞。HTTP指纹识别原理主要是通过记录不同服务器对http协议执行中的微小差别来进行识别。

#### 工具——whatweb

> whatweb 域名

## nmap版本侦测

- 高速。并行进行套接字操作，实现一组高效的探测匹配定义语法
- 尽可能地确定应用名字与版本名字
- 支持TCP/UDP协议，支持文本格式与二进制格式
- 支持多种平台服务地侦测
- 若检测到SSL，会调用openssl继续侦测运行在ssl上的具体协议
- 如果检测到sunRPC服务，就会调用brute-force RPC grinder进一步确定RPC程序编号、名字、版本号
- 支持完整的IPv6功能，包括TCP/UDP，基于TCP的SSL
- 通用平台枚举功能（CPE）
- 广泛应用程序数据库

用法：

> -sV:指定让nmap进行版本侦测
>
> --version-intensity<level>：指定版本侦测强度（0-9），默认为7。数值越高，探测出的服务就越精准，但是运行时间会比较长。
>
> --version-light：指定轻量侦测方式（intensity 2）
>
> --version-all：尝试使用所有的probes进行侦测（intensity 9）
>
> --version-trace：显示出详细的版本侦测过程信息

示例：

> nmap -sV 192.168.1.1

## 在线指纹分析

- 钟馗之眼（Zoomeye）

### 全面的信息收集工具dmitry

能最大限度地收集一个ip或者域名尽可能多的信息

用法

>  dmitry -w www.baidu.com
>
> 对一个域名进行whois查询对一个ip进行whois查询

> dmitry -i 192.168.1.1
>
> 对一个ip进行whois查询

> dmitry -p -f www.baidu.com
>
> 端口扫描，-p TCP端口扫描模式， -f 同时显示被防火墙过滤的端口

## 被动指纹分析

被动式探查技术不向目标系统发送数据包，攻击者将通过被动地监控网络通信地办法去推测目标系统地操作系统。所以，通过监控不同系统之间地网络通信，同样可以查明网络上地曹祖偶系统。被动式探查技术的成功取决于攻击者必须位于网络的通信枢纽，以及必须有一个可以用来捕获数据包的端口。

## 指纹分析的特点

- 操作系统识别结果甚至可用于实际欺骗的攻击
- 工具搜集信息常不够精确

## 指纹分析的防范

- 去掉或修改各种banner(OS&Service)
- 关闭不需要的端口
- 安装入侵检测软件











