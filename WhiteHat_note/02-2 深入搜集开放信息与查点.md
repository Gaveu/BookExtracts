# 02-2 深入搜集开放信息与查点

当我们已经对目标，比如它的公司的外部门户网站进行了充分的外围情报信息搜集，了解到网站域名、ip地址，并进一步针对门户网站搜集到一些关于此目标公司业务、人员与网站服务的细节信息。接着，我们就可以从外围信息搜集转到直接与目标网络环境进行交互，进行深入的信息搜集。

通过扫描的指纹值上的操作系统版本号或者应用程序版本号，寻找对应的漏洞信息。根据探测到的信息和对应的漏洞信息，利用漏洞，从而进行渗透。

## 扫描——搜集信息

活跃主机扫描，确定目标网络中那些主机在线（Ping Sweep技术）

标识目标系统开放的端口与服务（Port Scan技术）

操作系统识别（Operating System Identification/OS printing技术）

### 在线活跃主机扫描——ping sweep

活跃主机指已连接到网络上、处于运行状态且网络功能正常的主机。通常目标网络上会有很多已关闭电源的主机或空闲（没有主机使用）的IP段，需要首先从大范围的IP地址段中寻找出活跃的主机，然后进一步筛选出你感兴趣的目标主机

需要在较短的时间中，在较大的网络范围中确定“活”的机器

主要利用的原理：

- ICMP sweeps(ICMP ECHO requests)
- Broadcast ICMP
- TCP Sweep/UDP Sweep

#### 工具：fping

使用fping快速进行ping sweep查找活跃主机

> fping -g Desktop/hosts -s -b 100
>
> 例：向192.168.1.0/24网段的主机发送大小为100字节的数据（-b），扫描结束时输出统计信息（-s）
>
> fping -g 192.168.1.0/24 -s -b 100

也可以单独将各个IP地址放入本地文件中，用-f选项读取本地文件并扫描

#### 工具：arp_sweep

msf的一个模块，具体操作：

```shell
#扫描192.168.1.0/24网段中的活跃主机
root@kali:~# msfconsole
msf5 > use auxiliary/scanneer/discovery/arp_sweep
msf5 auxiliary(scanner/discovery/arp_sweep) > set RHOSTS 192.168.1.0/24
RHOSTS => 192.168.1.0/24
msf5 auxiliary(scanner/discovery/arp_sweep) > set THREADS 50
THREADS => 50
msf5 auxiliary(scanner/discovery/arp_sweep) > run
```

#### 工具：netenum

扫描时间更快

> netenum 192.168.1.0/24 5 1
>
> 5 为超时时间，1 为扫描方式（默认为1）

#### 工具：hping

可使用自定义数据包进行主机活跃探测

示例：

> hping3 -A -F -S 192.168.1.1
>
> 分别用ACK、FIN、SYN位置1的数据包对192.168.1.1进行探测

> hping3 -2  -p 445 192.168.1.1 -d 50 -E ./mysig.sig
>
> 向192.168.1.1的UDP端口445发送./mysig.sig的签名文件，数据包大小限制为50



### Port(TCP/UDP) Scan

端口扫描就是连接到目标系统的TCP或UDP端口上，确定哪些服务正在运行。

常见的扫描工具有：

- fping
- superscan
- nmap

主要目的：

- 确定目标系统上的TCP/UDP服务
- 标识目标系统的OS类型
- 更深入一步可以标识特定的应用程序或特定服务的版本

#### TCP 端口扫描

两台主机利用TCP来进行数据传输的话就必须先建立链接。端口扫描器就利用这个原理，它先给指定IP指定端口发送一个SYN请求数据包，假若目标主机受到该请求数据包的话就会对另一方有所回应。

#### UDP 端口扫描

主要依赖不开放的UDP端口将回应ICMP Port Unreachable消息。其结果不可靠的几个原因：

- 路由器经常丢弃UDP分组
- 许多UDP服务不响应探询
- 防火墙通常配置为丢弃DNS查询外的所有UDP分组

#### 工具：SuperScan

基于windows平台的工具。图形化界面，傻瓜式操作= =

#### 工具：nmap

主要用于基本的信息收集，包括主机的活动状态、主机端口开放状况、应用服务及版本、操作系统与设备类型等待。另外nmap完全支持ipv6；而nmap脚本引擎（NSE）结合内置的丰富的Lua脚本让其支持的功能更加全面、更加精细（如提供丰富的HTTP相关的扫描脚本）

有命令行界面和图形用户界面

建议直接参考nmap的参考指南，根据实际情况进行实操

示例：

>nmap 192.168.1.1
>
>扫描192.168.1.1主机的所有开放端口（基于tcp connect技术）
>
>nmap -sT 192.168.1.1
>
>扫描192.168.1.1主机的所有开放端口（基于tcp SYN技术）
>
>nmap -sS  192.168.1.1
>
>扫描192.168.1.1主机的所有开放端口（基于tcp stealth scanning，较隐蔽）
>
>nmap -sS  -O 192.168.1.1
>
>扫描192.168.1.1主机的所有开放端口，并尝试识别被测主机的操作系统
>
>nmap -sU 192.168.1.1
>
>扫描192.168.1.1主机的所有开放端口（UDP端口）

> nmap -iL ./scannmap.txt
>
> 扫描本地文件scannmap.txt中所列IP的主机开放端口

> nmap 192.168.1.0/24-exclude 192.168.1.188
>
> 扫描除了192.168.1.188外的192.168.1.0/24网段所有主机的开放端口

> nmap -p80,21,3389,135,139 192.168.1.1
>
> 扫描192.168.1.1主机的80、21、3389、135、139端口是否开放

也可以扫描在线活跃主机：

> nmap -sP 192.168.1.0/24
>
> 扫描网段192.168.1.0/24中的活跃主机

nmap对端口状态的分析力度更为细致，共分为六个状态：open、closed、filtered、unfiltered、open|filtered、closed|filtered。

- open：一个应用程序正在此端口上进行监听，以接受来自tcp、udp协议的数据。这是在渗透测试中最关注的一类端口，开放端口往往能够为我们提供一条进入系统的攻击路径
- closed：关闭的端口指的是主机已相应，但没有应用程序监听的端口。这些信息并非毫无价值，扫描出关闭端口至少说明主机是活跃的
- filtered：指nmap不能确认端口是否开放，但根据响应数据猜测该端口可能被防火墙等设备过滤
- unfiltered：仅在使用ACK扫描时，nmap无法确定端口是否开放，会归为此类。可以使用其他类型的扫描（如windows扫描、SYN扫描、FIN扫描）进一步确认端口信息

#### 工具：zenmap

图形化界面的nmap，傻瓜式操作= =



### TCP端口扫描原理

三类原理：

- 标准扫描方法：
  - Vanllia connect()扫描
  - 半开SYN标记扫描
- 第三方与伪造TCP扫描方法：
  - FTP跳板扫描
  - 代理跳板扫描
- 隐秘TCP扫描方法：
  - 反转TCP标记扫描
  - ACK标记探测扫描
  - TCP分片扫描

#### Vanllia connect()扫描

TCP connect()端口扫描是最容易进行的一种，这种类型的扫描没有太多隐秘性。因为扫描工具会与目标主机的每一个端口建立TCP/IP连接，这增加了被发现和记录的可能性。

受益于TCP/IP协议的鲁棒性，connect()端口扫描是一种识别给指定目标主机上可访问TCP服务的准确方法。

攻击者首先向所要测试的端口发送一个SYN探测数据包，如果收到目标端口设置了SYN标记和ACK标记的数据包，攻击者就可以判定该端口是开放的，之后攻击者再发送一个ACK数据包结束这个三次握手过程。如果目标端口是关闭的，攻击者就会收到一个直接返回的RST/ACK数据包。

#### 半开SYN标记扫描

在进行半开SYN端口扫描时，发现服务器的某个端口是开放的之后，客户端向服务器发送一个RST数据包作为三次握手过程的最后一步，而不是一个ACK数据包。RST数据包将对连接进行突然的重置，同时因为服务器没有收到相应的ACK数据包，三次握手的过程也就没法真正完成，连接尝试也不会被目标主机记录。

向目标端口发送一个SYN探测数据包，之后受到一个SYN/ACK数据包，表明目标端口是开放的。通常这个时候，connect()扫描器应该向目标主机发送一个ACK数据包以建立链接，但进行半开扫描时不会这样做，而是发送一个RST数据包来重置连接。

### UDP端口扫描原理

由于UDP是一种无连接的协议，只有两中方式可以有效地枚举IP网络内可访问的UDP网络服务：

- 向目标主机所有的65535个UDP端口发送UDP探测数据包，之后等待“ICMP目的端口不可达”消息以识别不可访问UDP端口
- 使用特定UDP服务客户端（如snmpwalk、dig或xftp）向目标UDP网络服务发送UDP数据包，之后等待肯定性的响应信息

UDP端口扫描是一种反转的扫描类型，在这种类型的扫描中，开放端口没有响应信息，而端口是关闭时，目标主机反而会给出“ICMP 目的端口不可达”消息。

### 第三方以及欺骗性TCP扫描方法

第三方端口扫描方法要点在于：通过第三方有漏洞的服务器作为跳板进行扫描，以尽可能掩藏网络扫描的真正发起者。这个方法的一个额外好处在于可以获取对防火墙配置的更深了解，这是通过将那些目标主机信任但存在漏洞的主机作为跳板实现的。

FTP跳板扫描

运行着过期的FTP服务的主机可能会成为众多TCP攻击（包括端口扫描）的跳板。PORT命令用于将数据发送到用户指定的主机和端口，很多FTP服务器在使用PORT命令处理连接时存在这样的一个漏洞，







